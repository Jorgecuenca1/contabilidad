{% extends 'base.html' %}

{% block title %}Dashboard Principal - Sistema Contable Integral{% endblock %}

{% block content %}
<!-- Encabezado de Bienvenida -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient-primary text-white shadow-lg">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="bi bi-speedometer2"></i> ¡Bienvenido al Sistema Contable Integral!</h1>
                        <p class="lead mb-2">Sistema profesional para contadores - Cumplimiento 100% con legislación colombiana</p>
                        <p class="mb-0">
                            <i class="bi bi-person-circle"></i> <strong>Contador:</strong> {{ user.get_full_name|default:user.username }}
                            | <i class="bi bi-calendar-date"></i> <strong>Fecha:</strong> <span id="currentDate"></span>
                            | <i class="bi bi-clock"></i> <strong>Hora:</strong> <span id="currentTime"></span>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="display-4">
                            <i class="bi bi-calculator-fill"></i>
                        </div>
                        <p class="mb-0"><strong>Versión Profesional 2025</strong></p>
                        <small>Licencia Completa Activada</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Selector de Empresa -->
{% if can_select_company %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-building-gear"></i> Seleccionar Empresa</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-2"><strong>Empresa Activa:</strong> 
                            {% if current_company %}
                                <span class="badge bg-success fs-6">{{ current_company.name }} ({{ current_company.tax_id }})</span>
                            {% else %}
                                <span class="badge bg-warning fs-6">Ninguna empresa seleccionada</span>
                            {% endif %}
                        </p>
                        <p class="text-muted mb-0">Como {{ user_role|title }}, puedes seleccionar la empresa que deseas administrar.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <select class="form-select" id="companySelector" onchange="selectCompany()">
                            <option value="">Seleccionar empresa...</option>
                            {% for company in user_companies %}
                                <option value="{{ company.id }}" {% if current_company.id == company.id %}selected{% endif %}>
                                    {{ company.name }} ({{ company.tax_id }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif current_company %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info" role="alert">
            <i class="bi bi-building-check"></i> <strong>Empresa:</strong> {{ current_company.name }} ({{ current_company.tax_id }})
        </div>
    </div>
</div>
{% endif %}


<!-- Gestión de Módulos -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-grid-3x3-gap"></i> Módulos del Sistema</h2>
                <p class="text-muted">Haga clic en cualquier módulo para acceder a sus funcionalidades completas</p>
            </div>
            <div>
                <a href="{% url 'core:manage_modules' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Agregar Módulos
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Módulos Especializados -->
{% if is_healthcare_company %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success">
            <h5><i class="bi bi-heart-pulse"></i> Módulos del Sector Salud</h5>
            <p class="mb-0">Módulos especializados disponibles para empresas del sector salud</p>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Módulo de Historia Clínica -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-success shadow-sm">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-clipboard-heart"></i> HISTORIA CLÍNICA</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Gestión integral de historias clínicas digitales, consultas médicas y expedientes.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'medical_records:dashboard' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-clipboard-data"></i> Dashboard Historias
                    </a>
                    <a href="{% url 'medical_records:new_record' %}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-file-medical"></i> Nueva Historia
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Módulo de Citas Médicas -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-calendar-plus"></i> CITAS MÉDICAS</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Sistema de agendamiento médico con gestión de especialistas y horarios.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'medical_appointments:dashboard' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-calendar-week"></i> Dashboard Citas
                    </a>
                    <a href="{% url 'medical_appointments:new_appointment' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-calendar-plus"></i> Nueva Cita
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Módulo de Laboratorio -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-warning shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5><i class="bi bi-thermometer-half"></i> LABORATORIO</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Sistema LIS completo para gestión de órdenes, resultados y muestras de laboratorio.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'laboratory:dashboard' %}" class="btn btn-warning btn-sm">
                        <i class="bi bi-clipboard-data"></i> Dashboard Lab
                    </a>
                    <a href="{% url 'laboratory:new_order' %}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-plus-circle"></i> Nueva Orden
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Módulo de Procedimientos Médicos -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-danger shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5><i class="bi bi-clipboard2-pulse"></i> PROCEDIMIENTOS</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Gestión de procedimientos médicos con códigos CUPS y seguimiento completo.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'medical_procedures:dashboard' %}" class="btn btn-danger btn-sm">
                        <i class="bi bi-clipboard-data"></i> Dashboard Proc.
                    </a>
                    <a href="{% url 'medical_procedures:new_procedure' %}" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-plus-circle"></i> Nuevo Proc.
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Módulo de Ginecología -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-info shadow-sm">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-heart-pulse"></i> GINECOLOGÍA</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Gestión completa de pacientes ginecológicos, citas, historias clínicas y procedimientos.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'gynecology:dashboard' %}" class="btn btn-info btn-sm">
                        <i class="bi bi-clipboard-data"></i> Dashboard Ginecología
                    </a>
                    <a href="{% url 'gynecology:new_patient' %}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-person-plus"></i> Nueva Paciente
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Módulo de Nómina (Especializado para Salud) -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-secondary shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5><i class="bi bi-people"></i> NÓMINA SALUD</h5>
            </div>
            <div class="card-body">
                <p class="card-text small">Gestión de empleados del sector salud con roles y especialidades médicas.</p>
                <div class="d-grid gap-2">
                    <a href="{% url 'payroll:new_employee' %}" class="btn btn-secondary btn-sm">
                        <i class="bi bi-person-plus"></i> Nuevo Empleado Médico
                    </a>
                    <a href="{% url 'payroll:dashboard' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-clipboard-data"></i> Ver Nómina
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Módulos Principales del Sistema -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="bi bi-briefcase"></i> Módulos Core</h3>
    </div>
</div>

<div class="row mb-4">
    <!-- Módulo de Contabilidad -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-journal-bookmark"></i> CONTABILIDAD GENERAL</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="{% url 'accounting:new_journal_entry' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> Nuevo Asiento Contable
                    </a>
                    <a href="{% url 'accounting:chart_of_accounts' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-list-ul"></i> Ver Plan de Cuentas
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulo de Cuentas por Cobrar -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-success shadow-sm">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-person-check"></i> CUENTAS POR COBRAR</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="{% url 'accounts_receivable:new_invoice' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-receipt"></i> Nueva Factura de Venta
                    </a>
                    <a href="{% url 'accounts_receivable:new_payment' %}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-cash-coin"></i> Registrar Pago Cliente
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulo de Cuentas por Pagar -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-danger shadow-sm">
            <div class="card-header bg-danger text-white">
                <h5><i class="bi bi-truck"></i> CUENTAS POR PAGAR</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="{% url 'accounts_payable:new_purchase_invoice' %}" class="btn btn-danger btn-sm">
                        <i class="bi bi-file-earmark-plus"></i> Nueva Factura Compra
                    </a>
                    <a href="{% url 'accounts_payable:supplier_payment' %}" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-credit-card"></i> Pagar Proveedor
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- Módulo de Tesorería -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-info shadow-sm">
            <div class="card-header bg-info text-white">
                <h5><i class="bi bi-bank"></i> TESORERÍA</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="{% url 'treasury:bank_movement' %}" class="btn btn-info btn-sm">
                        <i class="bi bi-arrow-left-right"></i> Movimiento Bancario
                    </a>
                    <a href="{% url 'treasury:bank_reconciliation' %}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-check2-square"></i> Conciliación Bancaria
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulo de Nómina -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-warning shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5><i class="bi bi-people-fill"></i> NÓMINA ELECTRÓNICA</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="/payroll/" class="btn btn-warning btn-sm">
                        <i class="bi bi-calculator"></i> Dashboard Nómina
                    </a>
                    <a href="{% url 'payroll:new_employee' %}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-person-plus"></i> Nuevo Empleado
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulo de Impuestos -->
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-secondary shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5><i class="bi bi-receipt-cutoff"></i> IMPUESTOS COLOMBIA</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="/taxes/" class="btn btn-secondary btn-sm">
                        <i class="bi bi-file-earmark-text"></i> Dashboard Impuestos
                    </a>
                    <a href="{% url 'taxes:new_tax_declaration' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-file-plus"></i> Nueva Declaración
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Módulos Especializados -->
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-gear-wide-connected"></i> Módulos Especializados</h2>
    </div>
</div>

<div class="row mb-4">
    <!-- Sector Público -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-building-gear"></i> SECTOR PÚBLICO</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="/public-sector/" class="btn btn-primary btn-sm">
                        <i class="bi bi-building-gear"></i> Dashboard Sector Público
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Reportes -->
    <div class="col-md-6 mb-3">
        <div class="card h-100 border-success shadow-sm">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-file-earmark-bar-graph"></i> CENTRO DE REPORTES</h5>
            </div>
            <div class="card-body">
                
                <div class="d-grid gap-2">
                    <a href="{% url 'reports:dashboard' %}" class="btn btn-success btn-sm">
                        <i class="bi bi-file-earmark-bar-graph"></i> Centro de Reportes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accesos Rápidos Frecuentes -->
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-lightning"></i> Accesos Rápidos Frecuentes</h2>
        <p class="text-muted">Las tareas más comunes del contador en un solo clic</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-journal-plus fs-1 text-primary mb-2"></i>
                <h6>Asiento Contable</h6>
                <a href="{% url 'accounting:new_journal_entry' %}" class="btn btn-primary btn-sm">Crear</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-receipt fs-1 text-success mb-2"></i>
                <h6>Factura Venta</h6>
                <a href="{% url 'accounts_receivable:new_invoice' %}" class="btn btn-success btn-sm">Crear</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-file-earmark-plus fs-1 text-danger mb-2"></i>
                <h6>Factura Compra</h6>
                <a href="{% url 'accounts_payable:new_purchase_invoice' %}" class="btn btn-danger btn-sm">Crear</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-cash-coin fs-1 text-warning mb-2"></i>
                <h6>Pago Cliente</h6>
                <a href="{% url 'accounts_receivable:new_payment' %}" class="btn btn-warning btn-sm">Crear</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-credit-card fs-1 text-info mb-2"></i>
                <h6>Pago Proveedor</h6>
                <a href="{% url 'accounts_payable:supplier_payment' %}" class="btn btn-info btn-sm">Crear</a>
            </div>
        </div>
    </div>
    
    <div class="col-md-2 mb-3">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <i class="bi bi-bank fs-1 text-secondary mb-2"></i>
                <h6>Conciliación</h6>
                <a href="{% url 'treasury:bank_reconciliation' %}" class="btn btn-secondary btn-sm">Crear</a>
            </div>
        </div>
    </div>
</div>

<!-- Alertas y Notificaciones -->
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-bell"></i> Alertas y Recordatorios</h2>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="alert alert-warning" role="alert">
            <h6><i class="bi bi-exclamation-triangle"></i> Declaración IVA</h6>
            <p class="mb-1">Vence en 5 días (31 de Agosto)</p>
            <small>Empresas pendientes: ABC S.A.S, XYZ Ltda</small>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="alert alert-info" role="alert">
            <h6><i class="bi bi-info-circle"></i> Nómina Quincenal</h6>
            <p class="mb-1">Procesamiento en 2 días</p>
            <small>247 empleados activos</small>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="alert alert-success" role="alert">
            <h6><i class="bi bi-check-circle"></i> Conciliaciones</h6>
            <p class="mb-1">Todas las cuentas conciliadas</p>
            <small>Última actualización: Hoy</small>
        </div>
    </div>
</div>

<!-- Módulos Disponibles -->
<div class="row">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-header">
                <h5><i class="bi bi-grid-3x3-gap"></i> Módulos del Sistema</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li>📊 <strong>Contabilidad General</strong> - Plan de cuentas PUC, asientos contables</li>
                            <li>💰 <strong>Cuentas por Cobrar</strong> - Facturación, clientes, cartera</li>
                            <li>🏪 <strong>Cuentas por Pagar</strong> - Proveedores, compras, pagos</li>
                            <li>🏦 <strong>Tesorería</strong> - Bancos, flujo de caja, conciliaciones</li>
                            <li>👥 <strong>Nómina</strong> - Empleados, liquidaciones, prestaciones sociales</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li>📋 <strong>Impuestos</strong> - IVA, retenciones, declaraciones DIAN</li>
                            <li>🏛️ <strong>Sector Público</strong> - Presupuesto, CDP, RP, contabilidad pública</li>
                            <li>📈 <strong>Reportes</strong> - Estados financieros, informes legales</li>
                            <li>📦 <strong>Inventarios</strong> - Control de mercancías y productos</li>
                            <li>🏢 <strong>Activos Fijos</strong> - Depreciaciones, mantenimientos</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.shadow-lg {
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

.display-4 {
    font-size: 3.5rem;
}

.fs-1 {
    font-size: calc(1.375rem + 1.5vw) !important;
}

.fs-2 {
    font-size: calc(1.325rem + 0.9vw) !important;
}

@media (max-width: 768px) {
    .display-4 {
        font-size: 2rem;
    }
}

.alert {
    border-left: 4px solid;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-info {
    border-left-color: #0dcaf0;
}

.alert-success {
    border-left-color: #198754;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function updateDateTime() {
    const now = new Date();
    const dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const timeOptions = { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    };
    
    document.getElementById('currentDate').textContent = now.toLocaleDateString('es-CO', dateOptions);
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-CO', timeOptions);
}

// Actualizar fecha y hora cada segundo
updateDateTime();
setInterval(updateDateTime, 1000);

// Función para seleccionar empresa
function selectCompany() {
    const selector = document.getElementById('companySelector');
    const companyId = selector.value;
    
    if (!companyId) {
        return;
    }
    
    // Mostrar indicador de carga
    selector.disabled = true;
    
    // Enviar solicitud AJAX
    fetch('{% url "core:select_company" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'company_id=' + encodeURIComponent(companyId)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar la página para mostrar los datos de la empresa seleccionada
            window.location.reload();
        } else {
            alert('Error al seleccionar empresa: ' + data.error);
            selector.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al comunicarse con el servidor');
        selector.disabled = false;
    });
}

// Mostrar mensaje de bienvenida
document.addEventListener('DOMContentLoaded', function() {
    // Simular carga de datos
    setTimeout(function() {
        console.log('Sistema Contable Integral cargado completamente');
    }, 1000);
});
</script>
{% endblock %}