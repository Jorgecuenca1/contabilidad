{% extends 'base.html' %}

{% block title %}Catálogo CUPS{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-book me-2"></i>Catálogo CUPS</h1>
                <div>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newCupsModal">
                        <i class="bi bi-plus-circle me-1"></i>Nuevo CUPS
                    </button>
                    <a href="{% url 'medical_procedures:procedure_templates' %}" class="btn btn-outline-primary">
                        <i class="bi bi-file-medical me-1"></i>Plantillas
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumb -->
    <div class="row mb-3">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'medical_procedures:dashboard' %}">Procedimientos</a></li>
                    <li class="breadcrumb-item active">Catálogo CUPS</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="category" class="form-label">Categoría</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">Todas las categorías</option>
                                <option value="consulta" {% if filters.category == 'consulta' %}selected{% endif %}>Consulta</option>
                                <option value="procedimiento" {% if filters.category == 'procedimiento' %}selected{% endif %}>Procedimiento</option>
                                <option value="quirurgico" {% if filters.category == 'quirurgico' %}selected{% endif %}>Quirúrgico</option>
                                <option value="diagnostico" {% if filters.category == 'diagnostico' %}selected{% endif %}>Diagnóstico</option>
                                <option value="medicamento" {% if filters.category == 'medicamento' %}selected{% endif %}>Medicamento</option>
                                <option value="material" {% if filters.category == 'material' %}selected{% endif %}>Material</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="section" class="form-label">Sección</label>
                            <select class="form-select" id="section" name="section">
                                <option value="">Todas las secciones</option>
                                <option value="01" {% if filters.section == '01' %}selected{% endif %}>01 - Consulta Externa</option>
                                <option value="02" {% if filters.section == '02' %}selected{% endif %}>02 - Apoyo Diagnóstico</option>
                                <option value="03" {% if filters.section == '03' %}selected{% endif %}>03 - Procedimientos</option>
                                <option value="04" {% if filters.section == '04' %}selected{% endif %}>04 - Quirúrgico</option>
                                <option value="05" {% if filters.section == '05' %}selected{% endif %}>05 - Ginecología</option>
                                <option value="06" {% if filters.section == '06' %}selected{% endif %}>06 - Obstetricia</option>
                                <option value="07" {% if filters.section == '07' %}selected{% endif %}>07 - Pediatría</option>
                                <option value="08" {% if filters.section == '08' %}selected{% endif %}>08 - Medicina General</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   placeholder="Código CUPS, nombre o descripción..." value="{{ filters.search }}">
                        </div>
                        <div class="col-md-1">
                            <label for="active_only" class="form-label">Estado</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="active_only" name="active_only" 
                                       {% if filters.active_only %}checked{% endif %}>
                                <label class="form-check-label" for="active_only">
                                    Solo Activos
                                </label>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Procedimientos CUPS</h5>
                    <div>
                        <span class="badge bg-primary me-2">{{ cups_procedures|length }} procedimientos</span>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="exportCups('excel')">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="exportCups('pdf')">
                                <i class="bi bi-file-earmark-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if cups_procedures %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Código CUPS</th>
                                        <th>Nombre</th>
                                        <th>Categoría</th>
                                        <th>Especialidad</th>
                                        <th>Valor</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for procedure in cups_procedures %}
                                    <tr class="{% if not procedure.is_active %}table-secondary{% endif %}">
                                        <td>
                                            <strong class="text-primary">{{ procedure.cups_code }}</strong><br>
                                            <small class="text-muted">Sección: {{ procedure.section }}</small>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ procedure.name }}</strong>
                                                {% if procedure.description %}
                                                    <br><small class="text-muted">{{ procedure.description|truncatechars:80 }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if procedure.category == 'consulta' %}
                                                <span class="badge bg-info">Consulta</span>
                                            {% elif procedure.category == 'procedimiento' %}
                                                <span class="badge bg-primary">Procedimiento</span>
                                            {% elif procedure.category == 'quirurgico' %}
                                                <span class="badge bg-danger">Quirúrgico</span>
                                            {% elif procedure.category == 'diagnostico' %}
                                                <span class="badge bg-warning">Diagnóstico</span>
                                            {% elif procedure.category == 'medicamento' %}
                                                <span class="badge bg-success">Medicamento</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ procedure.get_category_display }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if procedure.specialty %}
                                                {{ procedure.specialty.name }}
                                            {% else %}
                                                <small class="text-muted">General</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if procedure.base_price %}
                                                <strong class="text-success">${{ procedure.base_price|floatformat:0 }}</strong>
                                                {% if procedure.uvr_value %}
                                                    <br><small class="text-muted">{{ procedure.uvr_value }} UVR</small>
                                                {% endif %}
                                            {% else %}
                                                <small class="text-muted">No definido</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if procedure.is_active %}
                                                <span class="badge bg-success">Activo</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactivo</span>
                                            {% endif %}
                                            {% if procedure.requires_authorization %}
                                                <br><span class="badge bg-warning">Req. Autorización</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{% url 'medical_procedures:cups_detail' procedure.id %}" 
                                                   class="btn btn-outline-primary" title="Ver Detalles">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-outline-success" 
                                                        onclick="useProcedure({{ procedure.id }})" title="Usar en Cita">
                                                    <i class="bi bi-plus-square"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" 
                                                        onclick="editCups({{ procedure.id }})" title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-info" 
                                                        onclick="createTemplate({{ procedure.id }})" title="Crear Plantilla">
                                                    <i class="bi bi-file-medical"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación -->
                        {% if cups_procedures.has_other_pages %}
                        <nav aria-label="Paginación">
                            <ul class="pagination justify-content-center">
                                {% if cups_procedures.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.section %}&section={{ request.GET.section }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.active_only %}&active_only=on{% endif %}">&laquo; Primera</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ cups_procedures.previous_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.section %}&section={{ request.GET.section }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.active_only %}&active_only=on{% endif %}">Anterior</a>
                                    </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">
                                        Página {{ cups_procedures.number }} de {{ cups_procedures.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if cups_procedures.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ cups_procedures.next_page_number }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.section %}&section={{ request.GET.section }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.active_only %}&active_only=on{% endif %}">Siguiente</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ cups_procedures.paginator.num_pages }}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.section %}&section={{ request.GET.section }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.active_only %}&active_only=on{% endif %}">Última &raquo;</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-search display-1 text-muted"></i>
                            <h3 class="mt-3">No se encontraron procedimientos</h3>
                            <p class="text-muted">Modifique los filtros de búsqueda o agregue nuevos procedimientos CUPS.</p>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newCupsModal">
                                <i class="bi bi-plus-circle me-1"></i>Agregar Primer Procedimiento
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nuevo/Editar CUPS -->
<div class="modal fade" id="newCupsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cupsModalTitle">Nuevo Procedimiento CUPS</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cupsForm">
                    <input type="hidden" id="cups_id" name="cups_id">
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="cups_code" class="form-label">Código CUPS *</label>
                            <input type="text" class="form-control" id="cups_code" name="cups_code" 
                                   placeholder="Ej: 890101" required maxlength="10">
                            <div class="form-text">Código único según la clasificación CUPS</div>
                        </div>
                        <div class="col-md-4">
                            <label for="section" class="form-label">Sección *</label>
                            <select class="form-select" id="section_select" name="section" required>
                                <option value="">Seleccionar sección</option>
                                <option value="01">01 - Consulta Externa</option>
                                <option value="02">02 - Apoyo Diagnóstico</option>
                                <option value="03">03 - Procedimientos</option>
                                <option value="04">04 - Quirúrgico</option>
                                <option value="05">05 - Ginecología</option>
                                <option value="06">06 - Obstetricia</option>
                                <option value="07">07 - Pediatría</option>
                                <option value="08">08 - Medicina General</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="category_select" class="form-label">Categoría *</label>
                            <select class="form-select" id="category_select" name="category" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="consulta">Consulta</option>
                                <option value="procedimiento">Procedimiento</option>
                                <option value="quirurgico">Quirúrgico</option>
                                <option value="diagnostico">Diagnóstico</option>
                                <option value="medicamento">Medicamento</option>
                                <option value="material">Material</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="procedure_name" class="form-label">Nombre del Procedimiento *</label>
                            <input type="text" class="form-control" id="procedure_name" name="name" 
                                   placeholder="Nombre completo del procedimiento" required>
                        </div>
                        <div class="col-md-4">
                            <label for="specialty_select" class="form-label">Especialidad</label>
                            <select class="form-select" id="specialty_select" name="specialty">
                                <option value="">General</option>
                                {% for specialty in specialties %}
                                <option value="{{ specialty.id }}">{{ specialty.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="procedure_description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="procedure_description" name="description" rows="3" 
                                      placeholder="Descripción detallada del procedimiento..."></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="base_price" class="form-label">Valor Base (COP)</label>
                            <input type="number" class="form-control" id="base_price" name="base_price" 
                                   placeholder="0" min="0" step="100">
                        </div>
                        <div class="col-md-4">
                            <label for="uvr_value" class="form-label">Valor UVR</label>
                            <input type="number" class="form-control" id="uvr_value" name="uvr_value" 
                                   placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label for="estimated_duration" class="form-label">Duración (min)</label>
                            <input type="number" class="form-control" id="estimated_duration" name="estimated_duration" 
                                   placeholder="30" min="5" max="480">
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requires_authorization" name="requires_authorization">
                                <label class="form-check-label" for="requires_authorization">
                                    Requiere Autorización
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active_cups" name="is_active" checked>
                                <label class="form-check-label" for="is_active_cups">
                                    Estado Activo
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="prerequisites" class="form-label">Prerrequisitos</label>
                            <textarea class="form-control" id="prerequisites" name="prerequisites" rows="2" 
                                      placeholder="Exámenes o condiciones necesarias antes del procedimiento..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCups()">Guardar Procedimiento</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editCups(cupsId) {
    fetch(`/medical-procedures/cups/${cupsId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateCupsForm(data.procedure);
            document.getElementById('cupsModalTitle').textContent = 'Editar Procedimiento CUPS';
            const modal = new bootstrap.Modal(document.getElementById('newCupsModal'));
            modal.show();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cargar el procedimiento');
    });
}

function populateCupsForm(procedure) {
    document.getElementById('cups_id').value = procedure.id;
    document.getElementById('cups_code').value = procedure.cups_code;
    document.getElementById('section_select').value = procedure.section;
    document.getElementById('category_select').value = procedure.category;
    document.getElementById('procedure_name').value = procedure.name;
    document.getElementById('specialty_select').value = procedure.specialty_id || '';
    document.getElementById('procedure_description').value = procedure.description || '';
    document.getElementById('base_price').value = procedure.base_price || '';
    document.getElementById('uvr_value').value = procedure.uvr_value || '';
    document.getElementById('estimated_duration').value = procedure.estimated_duration || '';
    document.getElementById('requires_authorization').checked = procedure.requires_authorization;
    document.getElementById('is_active_cups').checked = procedure.is_active;
    document.getElementById('prerequisites').value = procedure.prerequisites || '';
}

function saveCups() {
    const form = document.getElementById('cupsForm');
    const formData = new FormData(form);
    
    const cupsId = document.getElementById('cups_id').value;
    const url = cupsId ? 
        `/medical-procedures/cups/edit/${cupsId}/` :
        '/medical-procedures/cups/new/';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar el procedimiento');
    });
}

function useProcedure(procedureId) {
    // Redirigir a crear cita con el procedimiento seleccionado
    window.location.href = `/medical-appointments/new/?procedure=${procedureId}`;
}

function createTemplate(procedureId) {
    // Redirigir a crear plantilla basada en el procedimiento
    window.location.href = `/medical-procedures/templates/new/?cups=${procedureId}`;
}

function exportCups(format) {
    const params = new URLSearchParams(window.location.search);
    params.append('export', format);
    window.open(`/medical-procedures/cups/export/?${params.toString()}`, '_blank');
}

// Reset modal form when closed
document.getElementById('newCupsModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('cupsForm').reset();
    document.getElementById('cups_id').value = '';
    document.getElementById('cupsModalTitle').textContent = 'Nuevo Procedimiento CUPS';
    document.getElementById('is_active_cups').checked = true;
});

// Validación de código CUPS
document.getElementById('cups_code').addEventListener('blur', function() {
    const code = this.value;
    if (code && code.length >= 6) {
        // Verificar si el código ya existe
        fetch(`/medical-procedures/cups/check-code/?code=${code}`)
        .then(response => response.json())
        .then(data => {
            if (data.exists && !document.getElementById('cups_id').value) {
                alert('Este código CUPS ya existe en el sistema');
                this.focus();
            }
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.table th {
    font-weight: 600;
    background-color: #f8f9fa;
}

.badge {
    font-size: 0.75em;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.table-secondary {
    opacity: 0.7;
}

.modal-lg {
    max-width: 900px;
}

.form-check-label {
    font-weight: 500;
}

.pagination {
    margin-top: 1rem;
}

.text-primary {
    font-family: 'Courier New', monospace;
}
</style>
{% endblock %}