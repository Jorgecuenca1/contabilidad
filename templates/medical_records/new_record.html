{% extends 'base.html' %}

{% block title %}Nueva Historia Clínica{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-file-medical me-2"></i>Nueva Historia Clínica</h1>
                <a href="{% url 'medical_records:list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Volver a Historias
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Crear Nueva Historia Clínica</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Información del Paciente -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-person me-2"></i>Información del Paciente</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="patient" class="form-label">Paciente *</label>
                                <select class="form-select" id="patient" name="patient" required>
                                    <option value="">Seleccionar paciente...</option>
                                    {% for patient in patients %}
                                        <option value="{{ patient.id }}">{{ patient.get_full_name }} - {{ patient.document_number }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="medical_record_number" class="form-label">Número de Historia Clínica *</label>
                                <input type="text" class="form-control" id="medical_record_number" name="medical_record_number" required>
                            </div>
                        </div>
                        
                        <!-- Información Médica -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-clipboard-heart me-2"></i>Información Médica</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="chief_complaint" class="form-label">Motivo de Consulta *</label>
                                <textarea class="form-control" id="chief_complaint" name="chief_complaint" rows="3" required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="present_illness" class="form-label">Enfermedad Actual</label>
                                <textarea class="form-control" id="present_illness" name="present_illness" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="past_medical_history" class="form-label">Antecedentes Médicos</label>
                                <textarea class="form-control" id="past_medical_history" name="past_medical_history" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="family_history" class="form-label">Antecedentes Familiares</label>
                                <textarea class="form-control" id="family_history" name="family_history" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="current_medications" class="form-label">Medicamentos Actuales</label>
                                <textarea class="form-control" id="current_medications" name="current_medications" rows="3"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="allergies" class="form-label">Alergias</label>
                                <textarea class="form-control" id="allergies" name="allergies" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- Examen Físico -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-heart-pulse me-2"></i>Examen Físico</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="blood_pressure" class="form-label">Presión Arterial</label>
                                <input type="text" class="form-control" id="blood_pressure" name="blood_pressure" placeholder="120/80">
                            </div>
                            <div class="col-md-3">
                                <label for="heart_rate" class="form-label">Frecuencia Cardíaca</label>
                                <input type="number" class="form-control" id="heart_rate" name="heart_rate" placeholder="72">
                            </div>
                            <div class="col-md-3">
                                <label for="temperature" class="form-label">Temperatura (°C)</label>
                                <input type="number" step="0.1" class="form-control" id="temperature" name="temperature" placeholder="36.5">
                            </div>
                            <div class="col-md-3">
                                <label for="weight" class="form-label">Peso (kg)</label>
                                <input type="number" step="0.1" class="form-control" id="weight" name="weight" placeholder="70.0">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="physical_examination" class="form-label">Examen Físico Detallado</label>
                                <textarea class="form-control" id="physical_examination" name="physical_examination" rows="4"></textarea>
                            </div>
                        </div>
                        
                        <!-- Diagnósticos -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-clipboard-pulse me-2"></i>Diagnósticos</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="primary_diagnosis" class="form-label">Diagnóstico Principal *</label>
                                <textarea class="form-control" id="primary_diagnosis" name="primary_diagnosis" rows="2" required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="secondary_diagnoses" class="form-label">Diagnósticos Secundarios</label>
                                <textarea class="form-control" id="secondary_diagnoses" name="secondary_diagnoses" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <!-- Plan de Tratamiento -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-prescription me-2"></i>Plan de Tratamiento</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="treatment_plan" class="form-label">Plan de Tratamiento</label>
                                <textarea class="form-control" id="treatment_plan" name="treatment_plan" rows="4"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="prescriptions" class="form-label">Medicamentos Prescritos</label>
                                <textarea class="form-control" id="prescriptions" name="prescriptions" rows="4"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="recommendations" class="form-label">Recomendaciones e Instrucciones</label>
                                <textarea class="form-control" id="recommendations" name="recommendations" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- Seguimiento -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="bi bi-calendar-check me-2"></i>Seguimiento</h6>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="follow_up_required" name="follow_up_required">
                                    <label class="form-check-label" for="follow_up_required">
                                        Requiere seguimiento
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="follow_up_date" class="form-label">Fecha de Seguimiento</label>
                                <input type="date" class="form-control" id="follow_up_date" name="follow_up_date">
                            </div>
                            <div class="col-md-4">
                                <label for="follow_up_specialty" class="form-label">Especialidad de Seguimiento</label>
                                <select class="form-select" id="follow_up_specialty" name="follow_up_specialty">
                                    <option value="">Seleccionar...</option>
                                    {% for specialty in specialties %}
                                        <option value="{{ specialty.id }}">{{ specialty.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-end gap-2">
                                    <a href="{% url 'medical_records:list' %}" class="btn btn-secondary">
                                        <i class="bi bi-x-circle me-1"></i>Cancelar
                                    </a>
                                    <button type="submit" name="save_draft" class="btn btn-outline-primary">
                                        <i class="bi bi-file-earmark me-1"></i>Guardar Borrador
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>Crear Historia Clínica
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generar número de historia clínica
    const patientSelect = document.getElementById('patient');
    const recordNumberInput = document.getElementById('medical_record_number');
    
    patientSelect.addEventListener('change', function() {
        if (this.value && !recordNumberInput.value) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            recordNumberInput.value = `HC${year}${month}${day}${random}`;
        }
    });
    
    // Habilitar/deshabilitar campos de seguimiento
    const followUpCheckbox = document.getElementById('follow_up_required');
    const followUpDate = document.getElementById('follow_up_date');
    const followUpSpecialty = document.getElementById('follow_up_specialty');
    
    followUpCheckbox.addEventListener('change', function() {
        if (this.checked) {
            followUpDate.removeAttribute('disabled');
            followUpSpecialty.removeAttribute('disabled');
        } else {
            followUpDate.setAttribute('disabled', 'disabled');
            followUpSpecialty.setAttribute('disabled', 'disabled');
            followUpDate.value = '';
            followUpSpecialty.value = '';
        }
    });
});
</script>
{% endblock %}