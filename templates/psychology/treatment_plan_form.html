{% extends 'base.html' %}
{% block title %}{% if plan %}Editar{% else %}Nuevo{% endif %} Plan de Tratamiento{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">
        <i class="bi bi-clipboard-plus"></i>
        {% if plan %}Editar Plan {{ plan.plan_number }}{% else %}Nuevo Plan de Tratamiento{% endif %}
    </h2>

    <form method="post">
        {% csrf_token %}

        <!-- Información Básica -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Básica</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Paciente <span class="text-danger">*</span></label>
                        <select name="patient" class="form-select" required {% if plan %}disabled{% endif %}>
                            <option value="">Seleccione un paciente...</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}" {% if plan and plan.patient.id == patient.id %}selected{% elif consultation and consultation.patient.id == patient.id %}selected{% endif %}>
                                {{ patient.third_party.name }} - {{ patient.third_party.identification_number }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Consulta Relacionada <span class="text-danger">*</span></label>
                        <select name="consultation" class="form-select" required>
                            <option value="">Seleccione una consulta...</option>
                            {% for cons in consultations %}
                            <option value="{{ cons.id }}" {% if plan and plan.consultation.id == cons.id %}selected{% elif consultation and consultation.id == cons.id %}selected{% endif %}>
                                {{ cons.consultation_number }} - {{ cons.consultation_date|date:"d/m/Y" }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                        <input type="date" name="start_date" class="form-control" required value="{{ plan.start_date|date:'Y-m-d'|default:'' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fecha Estimada de Finalización</label>
                        <input type="date" name="end_date" class="form-control" value="{{ plan.end_date|date:'Y-m-d'|default:'' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estado <span class="text-danger">*</span></label>
                        <select name="status" class="form-select" required>
                            <option value="active" {% if not plan or plan.status == 'active' %}selected{% endif %}>Activo</option>
                            <option value="completed" {% if plan and plan.status == 'completed' %}selected{% endif %}>Completado</option>
                            <option value="discontinued" {% if plan and plan.status == 'discontinued' %}selected{% endif %}>Discontinuado</option>
                            <option value="on_hold" {% if plan and plan.status == 'on_hold' %}selected{% endif %}>En pausa</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagnóstico -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-file-medical"></i> Diagnóstico</h6>
            </div>
            <div class="card-body">
                <textarea name="diagnosis" class="form-control" rows="3" required placeholder="Diagnóstico principal y secundarios...">{{ plan.diagnosis|default:'' }}</textarea>
            </div>
        </div>

        <!-- Objetivos -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-bullseye"></i> Objetivos</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Objetivos a Largo Plazo <span class="text-danger">*</span></label>
                        <textarea name="long_term_goals" class="form-control" rows="3" required placeholder="Metas generales del tratamiento...">{{ plan.long_term_goals|default:'' }}</textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Objetivos a Corto Plazo <span class="text-danger">*</span></label>
                        <textarea name="short_term_goals" class="form-control" rows="3" required placeholder="Metas específicas y medibles para las próximas sesiones...">{{ plan.short_term_goals|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Intervenciones -->
        <div class="card mb-3">
            <div class="card-header bg-warning">
                <h6 class="mb-0"><i class="bi bi-tools"></i> Enfoque e Intervenciones</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Enfoque Terapéutico <span class="text-danger">*</span></label>
                        <input type="text" name="therapeutic_approach" class="form-control" required value="{{ plan.therapeutic_approach|default:'' }}" placeholder="Ej: Terapia Cognitivo-Conductual, Terapia Psicodinámica, EMDR...">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Intervenciones Planificadas <span class="text-danger">*</span></label>
                        <textarea name="interventions" class="form-control" rows="4" required placeholder="Técnicas, estrategias y métodos específicos a utilizar...">{{ plan.interventions|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Frecuencia -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-calendar-week"></i> Frecuencia de Sesiones</h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label">Frecuencia de Sesiones <span class="text-danger">*</span></label>
                        <input type="text" name="session_frequency" class="form-control" required value="{{ plan.session_frequency|default:'' }}" placeholder="Ej: Semanal, Quincenal, Dos veces por semana...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Sesiones Estimadas</label>
                        <input type="number" name="estimated_sessions" class="form-control" value="{{ plan.estimated_sessions|default:'' }}" min="1" placeholder="Número aproximado">
                    </div>
                </div>
            </div>
        </div>

        <!-- Observaciones -->
        <div class="card mb-3">
            <div class="card-body">
                <label class="form-label">Observaciones Adicionales</label>
                <textarea name="observations" class="form-control" rows="2" placeholder="Notas adicionales, consideraciones especiales...">{{ plan.observations|default:'' }}</textarea>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="card mb-4">
            <div class="card-body">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Guardar Plan
                </button>
                <a href="{% url 'psychology:treatment_plan_list' %}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}
