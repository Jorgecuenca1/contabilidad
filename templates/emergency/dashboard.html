{% extends 'base.html' %}
{% block title %}Urgencias - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-hospital"></i> Módulo de Urgencias</h2>
        <div>
            <a href="{% url 'emergency:triage_create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Nuevo Triage
            </a>
            <a href="{% url 'emergency:admission_create' %}" class="btn btn-success">
                <i class="bi bi-clipboard-plus"></i> Nueva Admisión
            </a>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-clipboard-check fs-1 text-primary"></i>
                    <h3 class="mt-2">{{ total_admissions }}</h3>
                    <p class="text-muted mb-0">Total Admisiones</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history fs-1 text-warning"></i>
                    <h3 class="mt-2">{{ active_admissions }}</h3>
                    <p class="text-muted mb-0">Pacientes Activos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 text-success"></i>
                    <h3 class="mt-2">{{ admissions_today }}</h3>
                    <p class="text-muted mb-0">Ingresos Hoy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="bi bi-door-open fs-1 text-info"></i>
                    <h3 class="mt-2">{{ discharges_today }}</h3>
                    <p class="text-muted mb-0">Altas Hoy</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas por Estado -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Estado de Admisiones</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="p-3 border rounded mb-2">
                        <strong>En Espera:</strong> <span class="badge bg-info">{{ status_stats.waiting|default:0 }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 border rounded mb-2">
                        <strong>En Atención:</strong> <span class="badge bg-warning text-dark">{{ status_stats.in_attention|default:0 }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 border rounded mb-2">
                        <strong>En Observación:</strong> <span class="badge bg-primary">{{ status_stats.observation|default:0 }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="p-3 border rounded mb-2">
                        <strong>Altas:</strong> <span class="badge bg-success">{{ status_stats.discharged|default:0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tablero de Triage por Color -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Tablero de Triage - Pacientes Activos</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Triage I - Rojo -->
                <div class="col-md-4">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <strong>NIVEL I - RESUCITACIÓN (Rojo)</strong>
                            <span class="badge bg-white text-danger float-end">{{ triage_board.I|length }}</span>
                        </div>
                        <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                            {% for admission in triage_board.I %}
                            <div class="card mb-2 border-danger">
                                <div class="card-body p-2">
                                    <strong>{{ admission.patient.third_party.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ admission.admission_number }}</small>
                                    <br>
                                    <small>{{ admission.triage.chief_complaint|truncatewords:5 }}</small>
                                    <br>
                                    <span class="badge bg-{{ admission.status }}">{{ admission.get_status_display }}</span>
                                    <a href="{% url 'emergency:admission_detail' admission.id %}" class="btn btn-sm btn-outline-danger float-end">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-3">No hay pacientes</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Triage II - Naranja -->
                <div class="col-md-4">
                    <div class="card border-warning h-100">
                        <div class="card-header bg-warning text-dark">
                            <strong>NIVEL II - EMERGENCIA (Naranja)</strong>
                            <span class="badge bg-white text-warning float-end">{{ triage_board.II|length }}</span>
                        </div>
                        <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                            {% for admission in triage_board.II %}
                            <div class="card mb-2 border-warning">
                                <div class="card-body p-2">
                                    <strong>{{ admission.patient.third_party.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ admission.admission_number }}</small>
                                    <br>
                                    <small>{{ admission.triage.chief_complaint|truncatewords:5 }}</small>
                                    <br>
                                    <span class="badge bg-info">{{ admission.get_status_display }}</span>
                                    <a href="{% url 'emergency:admission_detail' admission.id %}" class="btn btn-sm btn-outline-warning float-end">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-3">No hay pacientes</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Triage III - Amarillo -->
                <div class="col-md-4">
                    <div class="card border-info h-100">
                        <div class="card-header bg-info text-white">
                            <strong>NIVEL III - URGENCIA (Amarillo)</strong>
                            <span class="badge bg-white text-info float-end">{{ triage_board.III|length }}</span>
                        </div>
                        <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                            {% for admission in triage_board.III %}
                            <div class="card mb-2 border-info">
                                <div class="card-body p-2">
                                    <strong>{{ admission.patient.third_party.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ admission.admission_number }}</small>
                                    <br>
                                    <small>{{ admission.triage.chief_complaint|truncatewords:5 }}</small>
                                    <br>
                                    <span class="badge bg-info">{{ admission.get_status_display }}</span>
                                    <a href="{% url 'emergency:admission_detail' admission.id %}" class="btn btn-sm btn-outline-info float-end">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-3">No hay pacientes</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Triage IV - Verde -->
                <div class="col-md-6">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <strong>NIVEL IV - URGENCIA MENOR (Verde)</strong>
                            <span class="badge bg-white text-success float-end">{{ triage_board.IV|length }}</span>
                        </div>
                        <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
                            {% for admission in triage_board.IV %}
                            <div class="card mb-2 border-success">
                                <div class="card-body p-2">
                                    <strong>{{ admission.patient.third_party.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ admission.admission_number }}</small>
                                    <br>
                                    <small>{{ admission.triage.chief_complaint|truncatewords:5 }}</small>
                                    <br>
                                    <span class="badge bg-info">{{ admission.get_status_display }}</span>
                                    <a href="{% url 'emergency:admission_detail' admission.id %}" class="btn btn-sm btn-outline-success float-end">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-3">No hay pacientes</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Triage V - Azul -->
                <div class="col-md-6">
                    <div class="card border-primary h-100">
                        <div class="card-header bg-primary text-white">
                            <strong>NIVEL V - NO URGENTE (Azul)</strong>
                            <span class="badge bg-white text-primary float-end">{{ triage_board.V|length }}</span>
                        </div>
                        <div class="card-body p-2" style="max-height: 250px; overflow-y: auto;">
                            {% for admission in triage_board.V %}
                            <div class="card mb-2 border-primary">
                                <div class="card-body p-2">
                                    <strong>{{ admission.patient.third_party.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ admission.admission_number }}</small>
                                    <br>
                                    <small>{{ admission.triage.chief_complaint|truncatewords:5 }}</small>
                                    <br>
                                    <span class="badge bg-info">{{ admission.get_status_display }}</span>
                                    <a href="{% url 'emergency:admission_detail' admission.id %}" class="btn btn-sm btn-outline-primary float-end">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center py-3">No hay pacientes</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Triages Pendientes de Admisión -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="bi bi-hourglass-split"></i> Triages Pendientes de Admisión</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Paciente</th>
                            <th>Nivel de Triage</th>
                            <th>Llegada</th>
                            <th>Motivo</th>
                            <th>Enfermera</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for triage in pending_triage %}
                        <tr>
                            <td><strong>{{ triage.triage_number }}</strong></td>
                            <td>{{ triage.patient.third_party.name }}</td>
                            <td>
                                {% if triage.triage_level == 'I' %}
                                <span class="badge bg-danger">Nivel I - Rojo</span>
                                {% elif triage.triage_level == 'II' %}
                                <span class="badge bg-warning text-dark">Nivel II - Naranja</span>
                                {% elif triage.triage_level == 'III' %}
                                <span class="badge bg-info">Nivel III - Amarillo</span>
                                {% elif triage.triage_level == 'IV' %}
                                <span class="badge bg-success">Nivel IV - Verde</span>
                                {% else %}
                                <span class="badge bg-primary">Nivel V - Azul</span>
                                {% endif %}
                            </td>
                            <td>{{ triage.arrival_datetime|date:"d/m/Y H:i" }}</td>
                            <td>{{ triage.chief_complaint|truncatewords:8 }}</td>
                            <td>{{ triage.triage_nurse.get_full_name }}</td>
                            <td>
                                <a href="{% url 'emergency:triage_detail' triage.id %}" class="btn btn-sm btn-outline-primary" title="Ver detalle">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'emergency:admission_create' %}?triage={{ triage.id }}" class="btn btn-sm btn-outline-success" title="Crear admisión">
                                    <i class="bi bi-clipboard-plus"></i>
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                No hay triages pendientes de admisión.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Accesos Rápidos -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-lightning"></i> Accesos Rápidos</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <a href="{% url 'emergency:triage_list' %}" class="btn btn-outline-primary w-100 py-3">
                        <i class="bi bi-list-ul fs-3"></i>
                        <div class="mt-2">Ver Todos los Triages</div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'emergency:admission_list' %}" class="btn btn-outline-success w-100 py-3">
                        <i class="bi bi-clipboard2-pulse fs-3"></i>
                        <div class="mt-2">Ver Todas las Admisiones</div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'emergency:triage_create' %}" class="btn btn-outline-warning w-100 py-3">
                        <i class="bi bi-plus-square fs-3"></i>
                        <div class="mt-2">Realizar Triage</div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{% url 'emergency:admission_list' %}?status=waiting" class="btn btn-outline-info w-100 py-3">
                        <i class="bi bi-clock-history fs-3"></i>
                        <div class="mt-2">Pacientes en Espera</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
