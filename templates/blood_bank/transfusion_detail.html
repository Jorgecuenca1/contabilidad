{% extends 'base.html' %}

{% block title %}{{ transfusion.transfusion_number }} - Transfusión{% endblock %}

{% block content %}
<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'blood_bank:index' %}">Banco de Sangre</a></li>
            <li class="breadcrumb-item"><a href="{% url 'blood_bank:transfusion_list' %}">Transfusiones</a></li>
            <li class="breadcrumb-item active">{{ transfusion.transfusion_number }}</li>
        </ol>
    </nav>

    <div class="row mb-3">
        <div class="col-md-8">
            <h2><i class="bi bi-activity text-danger"></i> Transfusión {{ transfusion.transfusion_number }}</h2>
            <p class="text-muted">{{ transfusion.start_datetime|date:"d/m/Y H:i" }}</p>
        </div>
        <div class="col-md-4 text-end">
            {% if transfusion.status == 'adverse_reaction' %}
                <span class="badge bg-danger fs-5">REACCIÓN ADVERSA</span>
            {% endif %}
            <br>
            <a href="{% url 'blood_bank:transfusion_list' %}" class="btn btn-secondary mt-2">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Información del Paciente -->
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-fill"></i> Información del Paciente</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="45%">Nombre:</th>
                            <td><strong>{{ transfusion.patient.third_party.first_name }} {{ transfusion.patient.third_party.last_name }}</strong></td>
                        </tr>
                        <tr>
                            <th>Documento:</th>
                            <td>{{ transfusion.patient.third_party.document_type }} {{ transfusion.patient.third_party.document_number }}</td>
                        </tr>
                        <tr>
                            <th>Historia Clínica:</th>
                            <td><strong>{{ transfusion.patient.medical_record_number }}</strong></td>
                        </tr>
                        <tr>
                            <th>Tipo Sangre:</th>
                            <td><span class="badge bg-danger">{{ transfusion.patient.blood_type|default:"-" }}</span></td>
                        </tr>
                        <tr>
                            <th>Ubicación:</th>
                            <td>{{ transfusion.patient_location|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard"></i> Estado de la Transfusión</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="45%">Estado:</th>
                            <td>
                                {% if transfusion.status == 'pending' %}
                                    <span class="badge bg-secondary">Pendiente</span>
                                {% elif transfusion.status == 'in_progress' %}
                                    <span class="badge bg-warning text-dark">En Progreso</span>
                                {% elif transfusion.status == 'completed' %}
                                    <span class="badge bg-success">Completada</span>
                                {% elif transfusion.status == 'adverse_reaction' %}
                                    <span class="badge bg-danger">Reacción Adversa</span>
                                {% elif transfusion.status == 'cancelled' %}
                                    <span class="badge bg-dark">Cancelada</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Fecha/Hora Inicio:</th>
                            <td>{{ transfusion.start_datetime|date:"d/m/Y H:i" }}</td>
                        </tr>
                        <tr>
                            <th>Fecha/Hora Fin:</th>
                            <td>{{ transfusion.end_datetime|date:"d/m/Y H:i"|default:"-" }}</td>
                        </tr>
                        {% if duration %}
                        <tr>
                            <th>Duración:</th>
                            <td><strong>{{ duration }} minutos</strong></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Información del Componente y Proceso -->
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-droplet-half"></i> Componente Sanguíneo</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="25%">Código Componente:</th>
                            <td><a href="{% url 'blood_bank:component_detail' transfusion.blood_component.id %}"><strong>{{ transfusion.blood_component.component_code }}</strong></a></td>
                        </tr>
                        <tr>
                            <th>Tipo Componente:</th>
                            <td><span class="badge bg-info">{{ transfusion.blood_component.get_component_type_display }}</span></td>
                        </tr>
                        <tr>
                            <th>Tipo Sangre:</th>
                            <td><span class="badge bg-danger fs-6">{{ transfusion.blood_component.blood_type }}</span></td>
                        </tr>
                        <tr>
                            <th>Volumen:</th>
                            <td><strong>{{ transfusion.blood_component.volume_ml }} ml</strong></td>
                        </tr>
                        <tr>
                            <th>Donante Origen:</th>
                            <td>
                                <a href="{% url 'blood_bank:donor_detail' transfusion.blood_component.donation.donor.id %}">
                                    {{ transfusion.blood_component.donation.donor.first_name }} {{ transfusion.blood_component.donation.donor.last_name }}
                                </a>
                                ({{ transfusion.blood_component.donation.donor.donor_code }})
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Personal Responsable</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="25%">Médico Ordena:</th>
                            <td>
                                {% if transfusion.ordering_physician %}
                                    {{ transfusion.ordering_physician.third_party.first_name }} {{ transfusion.ordering_physician.third_party.last_name }}
                                {% else %}
                                    <span class="text-muted">No asignado</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Enfermera Admin.:</th>
                            <td>
                                {% if transfusion.administering_nurse %}
                                    {{ transfusion.administering_nurse.third_party.first_name }} {{ transfusion.administering_nurse.third_party.last_name }}
                                {% else %}
                                    <span class="text-muted">No asignado</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Creado por:</th>
                            <td>{{ transfusion.created_by.get_full_name }}</td>
                        </tr>
                        <tr>
                            <th>Fecha Creación:</th>
                            <td>{{ transfusion.created_at|date:"d/m/Y H:i" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Signos Vitales Pre y Post -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse"></i> Signos Vitales</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Pre-Transfusión</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>PA Sistólica:</th>
                                    <td>{{ transfusion.pre_transfusion_bp_systolic|default:"-" }} mmHg</td>
                                </tr>
                                <tr>
                                    <th>PA Diastólica:</th>
                                    <td>{{ transfusion.pre_transfusion_bp_diastolic|default:"-" }} mmHg</td>
                                </tr>
                                <tr>
                                    <th>Frecuencia Cardíaca:</th>
                                    <td>{{ transfusion.pre_transfusion_heart_rate|default:"-" }} lpm</td>
                                </tr>
                                <tr>
                                    <th>Temperatura:</th>
                                    <td>{{ transfusion.pre_transfusion_temperature|default:"-" }} °C</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Post-Transfusión</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>PA Sistólica:</th>
                                    <td>{{ transfusion.post_transfusion_bp_systolic|default:"-" }} mmHg</td>
                                </tr>
                                <tr>
                                    <th>PA Diastólica:</th>
                                    <td>{{ transfusion.post_transfusion_bp_diastolic|default:"-" }} mmHg</td>
                                </tr>
                                <tr>
                                    <th>Frecuencia Cardíaca:</th>
                                    <td>{{ transfusion.post_transfusion_heart_rate|default:"-" }} lpm</td>
                                </tr>
                                <tr>
                                    <th>Temperatura:</th>
                                    <td>{{ transfusion.post_transfusion_temperature|default:"-" }} °C</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reacciones Adversas -->
            {% if transfusion.adverse_reaction_occurred %}
            <div class="card mb-3 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Reacción Adversa</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <strong>Tipo de Reacción:</strong> {{ transfusion.get_adverse_reaction_type_display }}<br>
                        <strong>Severidad:</strong> {{ transfusion.get_adverse_reaction_severity_display }}
                    </div>
                    {% if transfusion.adverse_reaction_description %}
                    <div class="mt-3">
                        <strong>Descripción de la Reacción:</strong>
                        <p>{{ transfusion.adverse_reaction_description }}</p>
                    </div>
                    {% endif %}
                    {% if transfusion.adverse_reaction_treatment %}
                    <div class="mt-3">
                        <strong>Tratamiento Administrado:</strong>
                        <p>{{ transfusion.adverse_reaction_treatment }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Indicación y Observaciones -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> Indicación y Observaciones</h5>
                </div>
                <div class="card-body">
                    {% if transfusion.indication %}
                    <div class="mb-3">
                        <strong>Indicación:</strong>
                        <p>{{ transfusion.indication }}</p>
                    </div>
                    {% endif %}

                    {% if transfusion.notes %}
                    <div>
                        <strong>Observaciones:</strong>
                        <p>{{ transfusion.notes }}</p>
                    </div>
                    {% endif %}

                    {% if not transfusion.indication and not transfusion.notes %}
                    <p class="text-muted mb-0">Sin indicaciones u observaciones registradas.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
