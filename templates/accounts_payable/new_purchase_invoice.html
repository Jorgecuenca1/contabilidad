{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Factura de Compra{% endblock %}

{% block contentdonde %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-receipt text-danger"></i> Nueva Factura de Compra</h2>
                    <p class="text-muted">Registra facturas de proveedores con contabilizaci√≥n autom√°tica</p>
                </div>
                <div>
                    <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n sobre Facturas de Compra -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="bi bi-info-circle"></i> ¬øQu√© es una Factura de Compra?</h5>
                </div>
                <div class="card-body">
                    <p><strong>Una factura de compra registra las adquisiciones de bienes y servicios de proveedores:</strong></p>
                    <div class="row">
                        <div class="col-md-4">
                            <h6>üìã Registro Contable:</h6>
                            <ul class="small">
                                <li>üìù <strong>D√©bito:</strong> Cuenta de gasto o activo</li>
                                <li>üìù <strong>D√©bito:</strong> IVA descontable (si aplica)</li>
                                <li>üìù <strong>Cr√©dito:</strong> Cuentas por pagar</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>üè¢ Control de Proveedores:</h6>
                            <ul class="small">
                                <li>üí∞ <strong>Seguimiento</strong> de cuentas por pagar</li>
                                <li>üìÖ <strong>Fechas de vencimiento</strong> para pagos</li>
                                <li>üìä <strong>An√°lisis</strong> de compras por proveedor</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>üßæ Cumplimiento Fiscal:</h6>
                            <ul class="small">
                                <li>üî¢ <strong>Numeraci√≥n</strong> consecutiva obligatoria</li>
                                <li>üìã <strong>Soporte</strong> para declaraciones</li>
                                <li>üí≥ <strong>IVA descontable</strong> autom√°tico</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Factura -->
    <form method="post" id="purchaseInvoiceForm">
        {% csrf_token %}
        
        <!-- Datos Generales -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-file-earmark-text"></i> Datos de la Factura</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="company" class="form-label">Empresa *</label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for company in companies %}
                                        <option value="{{ company.id }}">{{ company.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="supplier" class="form-label">Proveedor *</label>
                                <select class="form-select" id="supplier" name="supplier" required>
                                    <option value="">Seleccione proveedor...</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}" data-tax-id="{{ supplier.tax_id }}">
                                            {{ supplier.name }} - {{ supplier.tax_id }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="invoice_number" class="form-label">N√∫mero de Factura *</label>
                                <input type="text" class="form-control" id="invoice_number" name="invoice_number" 
                                       placeholder="Ej: FAC-001" required>
                            </div>
                            <div class="col-md-3">
                                <label for="date" class="form-label">Fecha de Factura *</label>
                                <input type="date" class="form-control" id="date" name="date" 
                                       value="{{ today|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <label for="due_date" class="form-label">Fecha de Vencimiento *</label>
                                <input type="date" class="form-control" id="due_date" name="due_date" required>
                            </div>
                            <div class="col-md-9">
                                <label for="description" class="form-label">Descripci√≥n</label>
                                <input type="text" class="form-control" id="description" name="description" 
                                       placeholder="Descripci√≥n general de la compra...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- L√≠neas de la Factura -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-list-ul"></i> L√≠neas de la Factura</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="addInvoiceLine()">
                            <i class="bi bi-plus-circle"></i> Agregar L√≠nea
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="invoiceLinesTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="25%">Cuenta Contable *</th>
                                        <th width="25%">Descripci√≥n</th>
                                        <th width="10%">Cantidad</th>
                                        <th width="12%">Precio Unit.</th>
                                        <th width="8%">% IVA</th>
                                        <th width="12%">Total</th>
                                        <th width="3%">Acc.</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceLinesBody">
                                    <!-- Las l√≠neas se generan din√°micamente -->
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="6" class="text-end"><strong>Subtotal:</strong></td>
                                        <td class="text-end"><strong id="subtotalAmount">$0.00</strong></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" class="text-end"><strong>IVA:</strong></td>
                                        <td class="text-end"><strong id="taxAmount">$0.00</strong></td>
                                        <td></td>
                                    </tr>
                                    <tr class="table-primary">
                                        <td colspan="6" class="text-end"><strong>TOTAL:</strong></td>
                                        <td class="text-end"><strong id="totalAmount">$0.00</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            <i class="bi bi-save"></i> Guardar Factura
                        </button>
                        <button type="reset" class="btn btn-secondary btn-lg" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar Formulario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Ayuda R√°pida -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-header">
                    <h6><i class="bi bi-question-circle"></i> Ejemplos de Facturas de Compra</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>üõí Compra de Inventario:</h6>
                            <small>
                                <strong>Cuenta:</strong> 1435 - Mercanc√≠as no fabricadas<br>
                                <strong>IVA:</strong> 19% descontable<br>
                                <em>Aumenta inventario y cuentas por pagar</em>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6>üè¢ Gastos Administrativos:</h6>
                            <small>
                                <strong>Cuenta:</strong> 5195 - Diversos gastos<br>
                                <strong>IVA:</strong> 19% descontable<br>
                                <em>Registra gastos operacionales</em>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6>üîß Activos Fijos:</h6>
                            <small>
                                <strong>Cuenta:</strong> 1524 - Equipo de oficina<br>
                                <strong>IVA:</strong> 19% descontable<br>
                                <em>Capitaliza activos depreciables</em>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-header {
    font-weight: 500;
}

.table th {
    font-size: 0.9rem;
    font-weight: 600;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}

#invoiceLinesTable input, #invoiceLinesTable select {
    font-size: 0.9rem;
}

.text-end {
    text-align: right !important;
}

.table-responsive {
    border-radius: 0.375rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let lineCounter = 0;

// Datos de cuentas para el selector
const accounts = [
    {% for account in accounts %}
    {
        id: '{{ account.id }}',
        code: '{{ account.code }}',
        name: '{{ account.name }}',
        nature: '{{ account.account_type.nature }}'
    },
    {% endfor %}
];

document.addEventListener('DOMContentLoaded', function() {
    // Agregar primera l√≠nea autom√°ticamente
    addInvoiceLine();
    
    // Configurar fecha de vencimiento autom√°tica (30 d√≠as)
    const dateInput = document.getElementById('date');
    const dueDateInput = document.getElementById('due_date');
    
    dateInput.addEventListener('change', function() {
        const date = new Date(this.value);
        date.setDate(date.getDate() + 30);
        dueDateInput.value = date.toISOString().split('T')[0];
    });
});

function addInvoiceLine() {
    lineCounter++;
    const tbody = document.getElementById('invoiceLinesBody');
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td class="text-center">${lineCounter}</td>
        <td>
            <select class="form-select account-select" name="account_${lineCounter}" onchange="calculateTotals()">
                <option value="">Seleccione cuenta...</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control" name="line_description_${lineCounter}" 
                   placeholder="Descripci√≥n del √≠tem...">
        </td>
        <td>
            <input type="number" class="form-control text-end" name="quantity_${lineCounter}" 
                   step="0.01" min="0" placeholder="1" value="1" onchange="calculateLineTotals(${lineCounter})">
        </td>
        <td>
            <input type="number" class="form-control text-end" name="unit_price_${lineCounter}" 
                   step="0.01" min="0" placeholder="0.00" onchange="calculateLineTotals(${lineCounter})">
        </td>
        <td>
            <select class="form-select" name="tax_rate_${lineCounter}" onchange="calculateLineTotals(${lineCounter})">
                <option value="0">0%</option>
                <option value="5">5%</option>
                <option value="19" selected>19%</option>
            </select>
        </td>
        <td>
            <input type="text" class="form-control text-end" id="line_total_${lineCounter}" 
                   readonly placeholder="$0.00">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceLine(this)" 
                    title="Eliminar l√≠nea">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    updateAccountSelects();
}

function updateAccountSelects() {
    const selects = document.querySelectorAll('.account-select');
    selects.forEach(select => {
        // Limpiar opciones existentes (excepto la primera)
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar cuentas
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.code} - ${account.name}`;
            select.appendChild(option);
        });
    });
}

function removeInvoiceLine(button) {
    const row = button.closest('tr');
    row.remove();
    calculateTotals();
}

function calculateLineTotals(lineNumber) {
    const quantity = parseFloat(document.querySelector(`input[name="quantity_${lineNumber}"]`).value) || 0;
    const unitPrice = parseFloat(document.querySelector(`input[name="unit_price_${lineNumber}"]`).value) || 0;
    const taxRate = parseFloat(document.querySelector(`select[name="tax_rate_${lineNumber}"]`).value) || 0;
    
    const subtotal = quantity * unitPrice;
    const tax = subtotal * (taxRate / 100);
    const total = subtotal + tax;
    
    document.getElementById(`line_total_${lineNumber}`).value = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(total);
    
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let taxAmount = 0;
    
    // Recorrer todas las l√≠neas
    for (let i = 1; i <= lineCounter; i++) {
        const quantityInput = document.querySelector(`input[name="quantity_${i}"]`);
        const unitPriceInput = document.querySelector(`input[name="unit_price_${i}"]`);
        const taxRateSelect = document.querySelector(`select[name="tax_rate_${i}"]`);
        
        if (quantityInput && unitPriceInput && taxRateSelect) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const taxRate = parseFloat(taxRateSelect.value) || 0;
            
            const lineSubtotal = quantity * unitPrice;
            const lineTax = lineSubtotal * (taxRate / 100);
            
            subtotal += lineSubtotal;
            taxAmount += lineTax;
        }
    }
    
    const total = subtotal + taxAmount;
    
    // Actualizar totales en la interfaz
    document.getElementById('subtotalAmount').textContent = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(subtotal);
    document.getElementById('taxAmount').textContent = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(taxAmount);
    document.getElementById('totalAmount').textContent = 
        new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(total);
}

function resetForm() {
    document.getElementById('purchaseInvoiceForm').reset();
    document.getElementById('invoiceLinesBody').innerHTML = '';
    lineCounter = 0;
    addInvoiceLine();
    calculateTotals();
}

// Validaci√≥n del formulario
document.getElementById('purchaseInvoiceForm').addEventListener('submit', function(e) {
    const lines = document.querySelectorAll('#invoiceLinesBody tr');
    if (lines.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos una l√≠nea a la factura');
        return false;
    }
    
    let hasValidLine = false;
    lines.forEach(line => {
        const accountSelect = line.querySelector('.account-select');
        const quantityInput = line.querySelector('input[name*="quantity_"]');
        const unitPriceInput = line.querySelector('input[name*="unit_price_"]');
        
        if (accountSelect && accountSelect.value && 
            quantityInput && parseFloat(quantityInput.value) > 0 &&
            unitPriceInput && parseFloat(unitPriceInput.value) > 0) {
            hasValidLine = true;
        }
    });
    
    if (!hasValidLine) {
        e.preventDefault();
        alert('Debe completar al menos una l√≠nea con cuenta, cantidad y precio');
        return false;
    }
});
</script>
{% endblock %}




