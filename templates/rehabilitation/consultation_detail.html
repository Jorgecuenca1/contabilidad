{% extends 'base.html' %}
{% block title %}Consulta {{ consultation.consultation_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clipboard-pulse"></i> Consulta {{ consultation.consultation_number }}</h2>
        <div>
            <a href="{% url 'rehabilitation:physical_assessment_create' consultation.id %}" class="btn btn-warning">
                <i class="bi bi-clipboard-plus"></i> Evaluación Física
            </a>
            <a href="{% url 'rehabilitation:plan_create' consultation.id %}" class="btn btn-info">
                <i class="bi bi-clipboard-check"></i> Crear Plan
            </a>
            <a href="{% url 'rehabilitation:consultation_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <!-- Información del Paciente -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person"></i> Información del Paciente</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Paciente:</strong> {{ consultation.patient.third_party.name }}</p>
                    <p><strong>Documento:</strong> {{ consultation.patient.third_party.identification_number }}</p>
                    <p><strong>Fecha de Nacimiento:</strong> {{ consultation.patient.birth_date|date:"d/m/Y" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Fisioterapeuta:</strong> {{ consultation.physiotherapist.get_full_name }}</p>
                    <p><strong>Fecha de Consulta:</strong> {{ consultation.consultation_date|date:"d/m/Y H:i" }}</p>
                    <p><strong>Estado:</strong>
                        {% if consultation.status == 'completed' %}
                        <span class="badge bg-success">Completada</span>
                        {% elif consultation.status == 'scheduled' %}
                        <span class="badge bg-warning text-dark">Programada</span>
                        {% elif consultation.status == 'cancelled' %}
                        <span class="badge bg-danger">Cancelada</span>
                        {% endif %}
                    </p>
                    <p><strong>Nivel de Dolor:</strong> <span class="badge bg-secondary">{{ consultation.pain_level }}/10</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Motivo de Consulta -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Motivo de Consulta</h6>
        </div>
        <div class="card-body">
            <p>{{ consultation.chief_complaint }}</p>
            <div class="row mt-2">
                {% if consultation.injury_mechanism %}
                <div class="col-md-6">
                    <p><strong>Mecanismo de Lesión:</strong> {{ consultation.injury_mechanism }}</p>
                </div>
                {% endif %}
                {% if consultation.onset_date %}
                <div class="col-md-3">
                    <p><strong>Fecha de Inicio:</strong> {{ consultation.onset_date|date:"d/m/Y" }}</p>
                </div>
                {% endif %}
                {% if consultation.pain_location %}
                <div class="col-md-3">
                    <p><strong>Localización:</strong> {{ consultation.pain_location }}</p>
                </div>
                {% endif %}
            </div>
            {% if consultation.pain_description %}
            <p class="mt-2"><strong>Descripción del Dolor:</strong> {{ consultation.pain_description }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Historia Médica -->
    {% if consultation.medical_history or consultation.surgical_history or consultation.medications or consultation.previous_treatments %}
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-clock-history"></i> Historia</h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% if consultation.medical_history %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Historia Médica</h6>
                    <p>{{ consultation.medical_history|linebreaks }}</p>
                </div>
                {% endif %}
                {% if consultation.surgical_history %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Historia Quirúrgica</h6>
                    <p>{{ consultation.surgical_history|linebreaks }}</p>
                </div>
                {% endif %}
                {% if consultation.medications %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Medicación Actual</h6>
                    <p>{{ consultation.medications|linebreaks }}</p>
                </div>
                {% endif %}
                {% if consultation.previous_treatments %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Tratamientos Previos</h6>
                    <p>{{ consultation.previous_treatments|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Limitaciones Funcionales -->
    {% if consultation.functional_limitations %}
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-x-circle"></i> Limitaciones Funcionales</h6>
        </div>
        <div class="card-body">
            <p>{{ consultation.functional_limitations|linebreaks }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Examen Físico -->
    {% if consultation.physical_exam_findings %}
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-clipboard-heart"></i> Hallazgos del Examen Físico</h6>
        </div>
        <div class="card-body">
            <p>{{ consultation.physical_exam_findings|linebreaks }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Diagnóstico y Plan -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0"><i class="bi bi-file-medical"></i> Diagnóstico y Objetivos</h6>
        </div>
        <div class="card-body">
            <h6>Diagnóstico</h6>
            <p>{{ consultation.diagnosis|linebreaks }}</p>
            <h6 class="mt-3">Objetivos del Tratamiento</h6>
            <p>{{ consultation.treatment_goals|linebreaks }}</p>
        </div>
    </div>

    <!-- Observaciones -->
    {% if consultation.observations %}
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-pencil-square"></i> Observaciones</h6>
        </div>
        <div class="card-body">
            <p>{{ consultation.observations|linebreaks }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Evaluación Física -->
    {% if physical_assessment %}
    <div class="card mb-3">
        <div class="card-header bg-warning d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-clipboard-data"></i> Evaluación Física Detallada</h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% if physical_assessment.posture_analysis %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Análisis Postural</h6>
                    <p>{{ physical_assessment.posture_analysis|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.gait_analysis %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Análisis de Marcha</h6>
                    <p>{{ physical_assessment.gait_analysis|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.range_of_motion_findings %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Rango de Movimiento (ROM)</h6>
                    <p>{{ physical_assessment.range_of_motion_findings|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.muscle_strength_findings %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Fuerza Muscular</h6>
                    <p>{{ physical_assessment.muscle_strength_findings|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.flexibility_assessment %}
                <div class="col-md-4 mb-3">
                    <h6 class="text-muted">Flexibilidad</h6>
                    <p>{{ physical_assessment.flexibility_assessment|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.balance_assessment %}
                <div class="col-md-4 mb-3">
                    <h6 class="text-muted">Balance</h6>
                    <p>{{ physical_assessment.balance_assessment|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.coordination_assessment %}
                <div class="col-md-4 mb-3">
                    <h6 class="text-muted">Coordinación</h6>
                    <p>{{ physical_assessment.coordination_assessment|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.palpation_findings %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Hallazgos de Palpación</h6>
                    <p>{{ physical_assessment.palpation_findings|linebreaks }}</p>
                </div>
                {% endif %}
                {% if physical_assessment.special_tests_performed %}
                <div class="col-md-6 mb-3">
                    <h6 class="text-muted">Pruebas Especiales</h6>
                    <p>{{ physical_assessment.special_tests_performed|linebreaks }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Planes de Rehabilitación -->
    {% if rehabilitation_plans %}
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-clipboard-pulse"></i> Planes de Rehabilitación</h6>
            <a href="{% url 'rehabilitation:plan_create' consultation.id %}" class="btn btn-sm btn-info">
                <i class="bi bi-plus"></i> Nuevo Plan
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Número</th>
                            <th>Fecha</th>
                            <th>Frecuencia</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plan in rehabilitation_plans %}
                        <tr>
                            <td>{{ plan.plan_number }}</td>
                            <td>{{ plan.start_date|date:"d/m/Y" }}</td>
                            <td>{{ plan.frequency_per_week }}x/semana</td>
                            <td>
                                {% if plan.status == 'active' %}
                                <span class="badge bg-success">Activo</span>
                                {% elif plan.status == 'completed' %}
                                <span class="badge bg-info">Completado</span>
                                {% elif plan.status == 'discontinued' %}
                                <span class="badge bg-danger">Discontinuado</span>
                                {% elif plan.status == 'on_hold' %}
                                <span class="badge bg-warning text-dark">En pausa</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'rehabilitation:plan_detail' plan.id %}" class="btn btn-sm btn-info">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Metadatos -->
    <div class="card">
        <div class="card-body">
            <small class="text-muted">
                <strong>Creado por:</strong> {{ consultation.created_by.get_full_name }} |
                <strong>Fecha:</strong> {{ consultation.created_at|date:"d/m/Y H:i" }}
                {% if consultation.updated_at != consultation.created_at %}
                | <strong>Última actualización:</strong> {{ consultation.updated_at|date:"d/m/Y H:i" }}
                {% endif %}
            </small>
        </div>
    </div>
</div>
{% endblock %}
