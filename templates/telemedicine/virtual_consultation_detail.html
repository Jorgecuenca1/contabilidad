{% extends 'base.html' %}
{% block title %}Detalle de Consulta Virtual - {{ consultation.consultation_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-laptop"></i> Consulta Virtual: {{ consultation.consultation_number }}</h2>
        <div>
            <a href="{% url 'telemedicine:document_create' %}?consultation={{ consultation.id }}" class="btn btn-success">
                <i class="bi bi-file-earmark-plus"></i> Generar Documento
            </a>
            <a href="{% url 'telemedicine:virtual_consultation_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Información Básica -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Número de Consulta:</strong>
                            <p class="mb-0">{{ consultation.consultation_number }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Fecha y Hora:</strong>
                            <p class="mb-0">{{ consultation.consultation_date|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Paciente:</strong>
                            <p class="mb-0">{{ consultation.patient.third_party.name }}</p>
                            <small class="text-muted">{{ consultation.patient.third_party.identification_number }}</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Médico:</strong>
                            <p class="mb-0">{{ consultation.doctor.third_party.name }}</p>
                            <small class="text-muted">{{ consultation.doctor.specialty }}</small>
                        </div>
                        {% if consultation.appointment %}
                        <div class="col-md-12 mb-3">
                            <strong>Cita Relacionada:</strong>
                            <p class="mb-0">
                                <a href="{% url 'telemedicine:appointment_detail' consultation.appointment.id %}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-calendar-event"></i> Ver Cita {{ consultation.appointment.appointment_number }}
                                </a>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Motivo y Síntomas -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard2-pulse"></i> Motivo de Consulta y Síntomas</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Motivo Principal:</strong>
                        <p class="mb-0">{{ consultation.chief_complaint }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Síntomas Actuales:</strong>
                        <p class="mb-0">{{ consultation.current_symptoms }}</p>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Duración:</strong>
                            <p class="mb-0">{{ consultation.symptom_duration }}</p>
                        </div>
                        {% if consultation.pain_scale %}
                        <div class="col-md-6 mb-3">
                            <strong>Escala del Dolor:</strong>
                            <p class="mb-0">
                                <span class="badge bg-{% if consultation.pain_scale <= 3 %}success{% elif consultation.pain_scale <= 6 %}warning{% else %}danger{% endif %} fs-6">
                                    {{ consultation.pain_scale }}/10
                                </span>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Examen y Signos Vitales -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-camera-video"></i> Examen Remoto y Signos Vitales</h5>
                </div>
                <div class="card-body">
                    {% if consultation.remote_examination %}
                    <div class="mb-3">
                        <strong>Hallazgos del Examen Remoto:</strong>
                        <p class="mb-0">{{ consultation.remote_examination }}</p>
                    </div>
                    {% endif %}

                    <div class="row">
                        {% if consultation.blood_pressure %}
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Presión Arterial</small>
                            <p class="mb-0"><strong>{{ consultation.blood_pressure }}</strong></p>
                        </div>
                        {% endif %}
                        {% if consultation.heart_rate %}
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">FC</small>
                            <p class="mb-0"><strong>{{ consultation.heart_rate }} lpm</strong></p>
                        </div>
                        {% endif %}
                        {% if consultation.temperature %}
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Temperatura</small>
                            <p class="mb-0"><strong>{{ consultation.temperature }}°C</strong></p>
                        </div>
                        {% endif %}
                        {% if consultation.oxygen_saturation %}
                        <div class="col-md-3 mb-2">
                            <small class="text-muted">Sat. O2</small>
                            <p class="mb-0"><strong>{{ consultation.oxygen_saturation }}%</strong></p>
                        </div>
                        {% endif %}
                    </div>
                    {% if consultation.blood_pressure or consultation.heart_rate or consultation.temperature or consultation.oxygen_saturation %}
                    <small class="text-muted">* Valores reportados por el paciente</small>
                    {% endif %}
                </div>
            </div>

            <!-- Diagnóstico y Tratamiento -->
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Diagnóstico y Tratamiento</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Diagnóstico:</strong>
                        <p class="mb-0">{{ consultation.diagnosis }}</p>
                    </div>
                    <div class="mb-3">
                        <strong>Plan de Tratamiento:</strong>
                        <p class="mb-0">{{ consultation.treatment_plan }}</p>
                    </div>
                    {% if consultation.medications_prescribed %}
                    <div class="mb-3">
                        <strong>Medicamentos Prescritos:</strong>
                        <div class="alert alert-warning mb-0">
                            {{ consultation.medications_prescribed }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recomendaciones -->
            {% if consultation.recommendations or consultation.follow_up_instructions %}
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Recomendaciones y Seguimiento</h6>
                </div>
                <div class="card-body">
                    {% if consultation.recommendations %}
                    <div class="mb-3">
                        <strong>Recomendaciones:</strong>
                        <p class="mb-0">{{ consultation.recommendations }}</p>
                    </div>
                    {% endif %}
                    {% if consultation.follow_up_instructions %}
                    <div class="mb-3">
                        <strong>Instrucciones de Seguimiento:</strong>
                        <p class="mb-0">{{ consultation.follow_up_instructions }}</p>
                    </div>
                    {% endif %}
                    {% if consultation.requires_follow_up %}
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-calendar-check"></i> <strong>Requiere consulta de seguimiento</strong>
                        {% if consultation.suggested_follow_up_date %}
                        <br>Fecha sugerida: {{ consultation.suggested_follow_up_date|date:"d/m/Y" }}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Órdenes Médicas -->
            {% if consultation.lab_tests_ordered or consultation.imaging_studies_ordered %}
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-file-medical"></i> Órdenes Médicas</h6>
                </div>
                <div class="card-body">
                    {% if consultation.lab_tests_ordered %}
                    <div class="mb-3">
                        <strong>Exámenes de Laboratorio:</strong>
                        <p class="mb-0">{{ consultation.lab_tests_ordered }}</p>
                    </div>
                    {% endif %}
                    {% if consultation.imaging_studies_ordered %}
                    <div class="mb-0">
                        <strong>Estudios de Imagen:</strong>
                        <p class="mb-0">{{ consultation.imaging_studies_ordered }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Calidad de Conexión -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-wifi"></i> Información Técnica</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Calidad de la Conexión:</strong>
                            <p class="mb-0">
                                {% if consultation.connection_quality == 'excellent' %}
                                <span class="badge bg-success">Excelente</span>
                                {% elif consultation.connection_quality == 'good' %}
                                <span class="badge bg-info">Buena</span>
                                {% elif consultation.connection_quality == 'fair' %}
                                <span class="badge bg-warning text-dark">Regular</span>
                                {% else %}
                                <span class="badge bg-danger">Mala</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% if consultation.technical_notes %}
                    <div>
                        <strong>Notas Técnicas:</strong>
                        <p class="mb-0">{{ consultation.technical_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-md-4">
            <!-- Documentos Relacionados -->
            {% if related_documents %}
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Documentos Generados</h6>
                </div>
                <div class="card-body">
                    {% for document in related_documents %}
                    <div class="mb-2">
                        <a href="{% url 'telemedicine:document_detail' document.id %}" class="btn btn-sm btn-outline-primary w-100">
                            <i class="bi bi-file-earmark"></i> {{ document.get_document_type_display }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Información del Sistema -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Información del Sistema</h6>
                </div>
                <div class="card-body">
                    <small class="text-muted">
                        <p class="mb-2"><strong>Creado:</strong><br>{{ consultation.created_at|date:"d/m/Y H:i" }}</p>
                        <p class="mb-2"><strong>Creado por:</strong><br>{{ consultation.created_by.get_full_name }}</p>
                        <p class="mb-0"><strong>Última modificación:</strong><br>{{ consultation.updated_at|date:"d/m/Y H:i" }}</p>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
