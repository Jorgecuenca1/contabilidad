{% extends 'base.html' %}
{% block title %}Detalle del Paciente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-person-badge"></i> Detalle del Paciente</h2>
        <div>
            <a href="{% url 'patients:patient_edit' patient.id %}" class="btn btn-warning">
                <i class="bi bi-pencil"></i> Editar
            </a>
            <a href="{% url 'patients:patient_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Información Personal -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-fill"></i> Información Personal
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Historia Clínica:</th>
                            <td><strong class="text-primary">{{ patient.medical_record_number }}</strong></td>
                        </tr>
                        <tr>
                            <th>Nombre Completo:</th>
                            <td><strong>{{ patient.third_party.name }}</strong></td>
                        </tr>
                        <tr>
                            <th>Tipo de Documento:</th>
                            <td>{{ patient.third_party.get_identification_type_display }}</td>
                        </tr>
                        <tr>
                            <th>Número de Documento:</th>
                            <td><strong>{{ patient.third_party.identification_number }}</strong></td>
                        </tr>
                        <tr>
                            <th>Fecha de Nacimiento:</th>
                            <td>{{ patient.third_party.birth_date|date:"d/m/Y" }}</td>
                        </tr>
                        <tr>
                            <th>Edad:</th>
                            <td>
                                <strong>{{ patient.get_age_display }}</strong>
                                {% if patient.is_minor %}
                                <span class="badge bg-info ms-1">Menor de Edad</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Género:</th>
                            <td>
                                {% if patient.third_party.gender == 'M' %}
                                <i class="bi bi-gender-male text-primary"></i> Masculino
                                {% elif patient.third_party.gender == 'F' %}
                                <i class="bi bi-gender-female text-danger"></i> Femenino
                                {% else %}
                                <i class="bi bi-gender-ambiguous"></i> Otro
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Tipo de Sangre:</th>
                            <td><span class="badge bg-danger">{{ patient.blood_type }}</span></td>
                        </tr>
                        <tr>
                            <th>Estado Civil:</th>
                            <td>{{ patient.get_marital_status_display }}</td>
                        </tr>
                        <tr>
                            <th>Etnia:</th>
                            <td>{{ patient.get_ethnicity_display }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Información de Contacto -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-telephone-fill"></i> Información de Contacto
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Teléfono:</th>
                            <td>{{ patient.third_party.phone|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Celular:</th>
                            <td>{{ patient.third_party.mobile|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Email:</th>
                            <td>{{ patient.third_party.email|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Dirección:</th>
                            <td>{{ patient.third_party.address|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Ciudad:</th>
                            <td>{{ patient.third_party.city|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Departamento:</th>
                            <td>{{ patient.third_party.state|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>País:</th>
                            <td>{{ patient.third_party.country|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Contacto de Emergencia -->
            {% if patient.emergency_contact_name %}
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle-fill"></i> Contacto de Emergencia
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Nombre:</th>
                            <td><strong>{{ patient.emergency_contact_name }}</strong></td>
                        </tr>
                        <tr>
                            <th>Parentesco:</th>
                            <td>{{ patient.emergency_contact_relationship|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Teléfono:</th>
                            <td>{{ patient.emergency_contact_phone|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Información de Aseguramiento -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-shield-fill-check"></i> Información de Aseguramiento
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">EPS:</th>
                            <td><strong>{{ patient.eps.name }}</strong></td>
                        </tr>
                        <tr>
                            <th>NIT EPS:</th>
                            <td>{{ patient.eps.nit }}</td>
                        </tr>
                        <tr>
                            <th>Código EPS:</th>
                            <td>{{ patient.eps.code }}</td>
                        </tr>
                        <tr>
                            <th>Régimen:</th>
                            <td>
                                {% if patient.regime_type == 'contributivo' %}
                                <span class="badge bg-success">Contributivo</span>
                                {% elif patient.regime_type == 'subsidiado' %}
                                <span class="badge bg-warning">Subsidiado</span>
                                {% elif patient.regime_type == 'especial' %}
                                <span class="badge bg-info">Especial</span>
                                {% else %}
                                <span class="badge bg-secondary">Particular</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Número de Afiliación:</th>
                            <td>{{ patient.insurance_number }}</td>
                        </tr>
                        <tr>
                            <th>Tipo de Usuario:</th>
                            <td>{{ patient.get_user_type_display }}</td>
                        </tr>
                        <tr>
                            <th>Cotizante:</th>
                            <td>{{ patient.cotizante_name|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>Nivel de Clasificación:</th>
                            <td>{{ patient.classification_level|default:"-" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Información Médica -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <i class="bi bi-heart-pulse-fill"></i> Información Médica
                </div>
                <div class="card-body">
                    <h6>Alergias:</h6>
                    {% if patient.allergies %}
                    <div class="alert alert-danger">
                        {{ patient.allergies|linebreaks }}
                    </div>
                    {% else %}
                    <p class="text-muted">No se reportan alergias</p>
                    {% endif %}

                    <h6 class="mt-3">Enfermedades Crónicas:</h6>
                    {% if patient.chronic_diseases %}
                    <div class="alert alert-warning">
                        {{ patient.chronic_diseases|linebreaks }}
                    </div>
                    {% else %}
                    <p class="text-muted">No se reportan enfermedades crónicas</p>
                    {% endif %}

                    <h6 class="mt-3">Observaciones:</h6>
                    {% if patient.observations %}
                    <div class="alert alert-info">
                        {{ patient.observations|linebreaks }}
                    </div>
                    {% else %}
                    <p class="text-muted">Sin observaciones</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Consentimientos y Autorizaciones -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-file-text-fill"></i> Consentimientos y Autorizaciones
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" disabled {% if patient.informed_consent_signed %}checked{% endif %}>
                                <label class="form-check-label">
                                    <i class="bi bi-check-circle{% if patient.informed_consent_signed %}-fill text-success{% endif %}"></i>
                                    Consentimiento Informado
                                </label>
                            </div>
                            {% if patient.informed_consent_date %}
                            <small class="text-muted">Fecha: {{ patient.informed_consent_date|date:"d/m/Y" }}</small>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" disabled {% if patient.data_treatment_authorized %}checked{% endif %}>
                                <label class="form-check-label">
                                    <i class="bi bi-check-circle{% if patient.data_treatment_authorized %}-fill text-success{% endif %}"></i>
                                    Tratamiento de Datos Personales
                                </label>
                            </div>
                            {% if patient.data_treatment_date %}
                            <small class="text-muted">Fecha: {{ patient.data_treatment_date|date:"d/m/Y" }}</small>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" disabled {% if patient.photo_authorization %}checked{% endif %}>
                                <label class="form-check-label">
                                    <i class="bi bi-check-circle{% if patient.photo_authorization %}-fill text-success{% endif %}"></i>
                                    Autorización de Fotografías
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Aseguramiento -->
    {% if insurance_history %}
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Historial de Aseguramiento
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>EPS Anterior</th>
                                    <th>EPS Nueva</th>
                                    <th>Fecha de Cambio</th>
                                    <th>Motivo</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in insurance_history %}
                                <tr>
                                    <td>{{ record.previous_eps.name }}</td>
                                    <td>{{ record.new_eps.name }}</td>
                                    <td>{{ record.change_date|date:"d/m/Y" }}</td>
                                    <td>{{ record.get_change_reason_display }}</td>
                                    <td>{{ record.observations|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Documentos -->
    {% if documents %}
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-file-earmark-text"></i> Documentos
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Fecha de Firma</th>
                                    <th>Archivo</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                <tr>
                                    <td>{{ doc.get_document_type_display }}</td>
                                    <td>{{ doc.description }}</td>
                                    <td>{{ doc.signed_date|date:"d/m/Y" }}</td>
                                    <td>
                                        {% if doc.file %}
                                        <a href="{{ doc.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> Descargar
                                        </a>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ doc.observations|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Información del Sistema -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> Información del Sistema
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted">Estado:</small><br>
                            {% if patient.is_active %}
                            <span class="badge bg-success">Activo</span>
                            {% else %}
                            <span class="badge bg-danger">Inactivo</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Fecha de Registro:</small><br>
                            <strong>{{ patient.created_at|date:"d/m/Y H:i" }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Última Actualización:</small><br>
                            <strong>{{ patient.updated_at|date:"d/m/Y H:i" }}</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Registrado Por:</small><br>
                            <strong>{{ patient.created_by.get_full_name|default:patient.created_by.username }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
