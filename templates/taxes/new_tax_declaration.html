{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Declaraci√≥n de Impuestos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-file-earmark-text text-danger"></i> Nueva Declaraci√≥n de Impuestos</h2>
                    <p class="text-muted">Registra declaraciones de IVA, Renta, ICA y otros impuestos DIAN</p>
                </div>
                <div>
                    <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n sobre Declaraciones -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="bi bi-info-circle"></i> Declaraciones de Impuestos en Colombia</h5>
                </div>
                <div class="card-body">
                    <p><strong>Las declaraciones de impuestos deben cumplir con los calendarios y formatos de la DIAN:</strong></p>
                    <div class="row">
                        <div class="col-md-4">
                            <h6>üìã Tipos Principales:</h6>
                            <ul class="small">
                                <li>üßæ <strong>IVA Bimestral:</strong> Cada 2 meses</li>
                                <li>üí∞ <strong>Renta Anual:</strong> Personas y empresas</li>
                                <li>üè¢ <strong>ICA Municipal:</strong> Actividades comerciales</li>
                                <li>üë• <strong>Retenci√≥n en la Fuente:</strong> Mensual</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>üìÖ Calendarios DIAN:</h6>
                            <ul class="small">
                                <li>üìÜ <strong>Fechas de vencimiento</strong> seg√∫n √∫ltimo d√≠gito NIT</li>
                                <li>‚è∞ <strong>Presentaci√≥n oportuna</strong> evita sanciones</li>
                                <li>üí≥ <strong>Pago simult√°neo</strong> con la declaraci√≥n</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>‚öñÔ∏è Cumplimiento:</h6>
                            <ul class="small">
                                <li>‚úÖ <strong>Formularios oficiales</strong> DIAN</li>
                                <li>üìä <strong>Informaci√≥n ex√≥gena</strong> cuando aplique</li>
                                <li>üîç <strong>Soporte documental</strong> completo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario de Declaraci√≥n -->
    <form method="post" id="taxDeclarationForm">
        {% csrf_token %}
        
        <!-- Datos Generales -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-building"></i> Datos de la Declaraci√≥n</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="company" class="form-label">Empresa *</label>
                                <select class="form-select" id="company" name="company" required>
                                    <option value="">Seleccione empresa...</option>
                                    {% for company in companies %}
                                        <option value="{{ company.id }}" data-nit="{{ company.tax_id }}">
                                            {{ company.name }} - {{ company.tax_id }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="tax_type" class="form-label">Tipo de Impuesto *</label>
                                <select class="form-select" id="tax_type" name="tax_type" required onchange="updateTaxInfo()">
                                    <option value="">Seleccione impuesto...</option>
                                    {% for tax_type in tax_types %}
                                        <option value="{{ tax_type.id }}" 
                                                data-rate="{{ tax_type.rate }}"
                                                data-frequency="{{ tax_type.frequency }}">
                                            {{ tax_type.name }} - {{ tax_type.rate }}%
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="period_year" class="form-label">A√±o Gravable *</label>
                                <select class="form-select" id="period_year" name="period_year" required>
                                    <option value="">Seleccione a√±o...</option>
                                    <option value="2023" {% if current_year == 2023 %}selected{% endif %}>2023</option>
                                    <option value="2024" {% if current_year == 2024 %}selected{% endif %}>2024</option>
                                    <option value="2025" {% if current_year == 2025 %}selected{% endif %}>2025</option>
                                    <option value="2026" {% if current_year == 2026 %}selected{% endif %}>2026</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="period_month" class="form-label">Per√≠odo</label>
                                <select class="form-select" id="period_month" name="period_month">
                                    <option value="">Anual</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="due_date" class="form-label">Fecha de Vencimiento *</label>
                                <input type="date" class="form-control" id="due_date" name="due_date" required>
                            </div>
                            <div class="col-md-8" id="taxInfo" style="display: none;">
                                <div class="alert alert-info mb-0">
                                    <h6><i class="bi bi-info-circle"></i> Informaci√≥n del Impuesto</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Tarifa:</strong> <span id="taxRate">0%</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Frecuencia:</strong> <span id="taxFrequency">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conceptos de la Declaraci√≥n -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-list-ol"></i> Conceptos de la Declaraci√≥n</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="addConcept()">
                            <i class="bi bi-plus-circle"></i> Agregar Concepto
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="conceptsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="15%">C√≥digo</th>
                                        <th width="30%">Concepto</th>
                                        <th width="15%">Base Gravable</th>
                                        <th width="10%">Tarifa %</th>
                                        <th width="15%">Valor Impuesto</th>
                                        <th width="10%">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="conceptsBody">
                                    <!-- Los conceptos se generan din√°micamente -->
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="3" class="text-end"><strong>Total Base Gravable:</strong></td>
                                        <td class="text-end"><strong id="totalBase">$0</strong></td>
                                        <td></td>
                                        <td class="text-end"><strong id="totalTax">$0</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- Conceptos Predefinidos -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-light">
                                    <h6><i class="bi bi-lightbulb"></i> Conceptos Comunes por Tipo de Impuesto:</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <strong>IVA:</strong>
                                            <ul class="small mb-0">
                                                <li>31 - Ventas gravadas 19%</li>
                                                <li>32 - Ventas gravadas 5%</li>
                                                <li>33 - IVA descontable</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Renta:</strong>
                                            <ul class="small mb-0">
                                                <li>26 - Patrimonio l√≠quido</li>
                                                <li>27 - Ingresos brutos</li>
                                                <li>28 - Renta l√≠quida gravable</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <strong>Retenci√≥n:</strong>
                                            <ul class="small mb-0">
                                                <li>23 - Retenci√≥n renta</li>
                                                <li>24 - Retenci√≥n IVA</li>
                                                <li>25 - Retenci√≥n ICA</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-danger btn-lg me-3">
                            <i class="bi bi-file-earmark-check"></i> Generar Declaraci√≥n
                        </button>
                        <button type="reset" class="btn btn-secondary btn-lg" onclick="resetForm()">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar Formulario
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Ayuda R√°pida -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-header">
                    <h6><i class="bi bi-question-circle"></i> Gu√≠a R√°pida de Declaraciones</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>üßæ Declaraci√≥n de IVA:</h6>
                            <small>
                                <strong>Bimestral:</strong> Enero-Febrero, Marzo-Abril, etc.<br>
                                <strong>Conceptos:</strong> Ventas gravadas, IVA descontable<br>
                                <strong>Vencimiento:</strong> Seg√∫n √∫ltimo d√≠gito del NIT<br>
                                <em>Formulario 300 - DIAN</em>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6>üí∞ Declaraci√≥n de Renta:</h6>
                            <small>
                                <strong>Anual:</strong> A√±o gravable completo<br>
                                <strong>Conceptos:</strong> Ingresos, costos, deducciones<br>
                                <strong>Vencimiento:</strong> Agosto-Octubre del a√±o siguiente<br>
                                <em>Formulario 110/210 - DIAN</em>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <h6>üè¢ Declaraci√≥n ICA:</h6>
                            <small>
                                <strong>Bimestral/Anual:</strong> Seg√∫n municipio<br>
                                <strong>Conceptos:</strong> Ingresos por actividad comercial<br>
                                <strong>Tarifa:</strong> Entre 0.2% y 1% seg√∫n actividad<br>
                                <em>Formulario municipal espec√≠fico</em>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-header {
    font-weight: 500;
}

.form-control:focus, .form-select:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}

.table th {
    font-size: 0.9rem;
    font-weight: 600;
}

.alert-info {
    background-color: #e7f3ff;
    border-color: #b6d7ff;
    color: #004085;
}

.alert-light {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let conceptCounter = 0;

function updateTaxInfo() {
    const select = document.getElementById('tax_type');
    const selectedOption = select.options[select.selectedIndex];
    const taxInfo = document.getElementById('taxInfo');
    
    if (selectedOption.value) {
        const rate = selectedOption.dataset.rate || '0';
        const frequency = selectedOption.dataset.frequency || 'Anual';
        
        document.getElementById('taxRate').textContent = rate + '%';
        document.getElementById('taxFrequency').textContent = frequency;
        
        taxInfo.style.display = 'block';
        
        // Actualizar fecha de vencimiento sugerida
        updateDueDate();
    } else {
        taxInfo.style.display = 'none';
    }
}

function updateDueDate() {
    // L√≥gica simplificada para fechas de vencimiento
    const today = new Date();
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 15);
    document.getElementById('due_date').value = nextMonth.toISOString().split('T')[0];
}

function addConcept() {
    conceptCounter++;
    const tbody = document.getElementById('conceptsBody');
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td class="text-center">${conceptCounter}</td>
        <td>
            <input type="text" class="form-control" name="concept_code_${conceptCounter}" 
                   placeholder="Ej: 31" maxlength="3">
        </td>
        <td>
            <input type="text" class="form-control" name="concept_name_${conceptCounter}" 
                   placeholder="Descripci√≥n del concepto">
        </td>
        <td>
            <input type="number" class="form-control text-end" name="tax_base_${conceptCounter}" 
                   step="0.01" min="0" placeholder="0.00" onchange="calculateTax(${conceptCounter})">
        </td>
        <td>
            <input type="number" class="form-control text-end" name="tax_rate_${conceptCounter}" 
                   step="0.01" min="0" max="100" placeholder="19" onchange="calculateTax(${conceptCounter})">
        </td>
        <td>
            <input type="number" class="form-control text-end" name="tax_amount_${conceptCounter}" 
                   step="0.01" min="0" placeholder="0.00" onchange="calculateTotals()">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeConcept(this)">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

function removeConcept(button) {
    const row = button.closest('tr');
    row.remove();
    calculateTotals();
}

function calculateTax(lineNumber) {
    const baseInput = document.querySelector(`input[name="tax_base_${lineNumber}"]`);
    const rateInput = document.querySelector(`input[name="tax_rate_${lineNumber}"]`);
    const amountInput = document.querySelector(`input[name="tax_amount_${lineNumber}"]`);
    
    if (baseInput && rateInput && amountInput) {
        const base = parseFloat(baseInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        
        if (base > 0 && rate > 0) {
            const taxAmount = base * (rate / 100);
            amountInput.value = taxAmount.toFixed(2);
        }
    }
    
    calculateTotals();
}

function calculateTotals() {
    let totalBase = 0;
    let totalTax = 0;
    
    // Recorrer todas las l√≠neas
    for (let i = 1; i <= conceptCounter; i++) {
        const baseInput = document.querySelector(`input[name="tax_base_${i}"]`);
        const amountInput = document.querySelector(`input[name="tax_amount_${i}"]`);
        
        if (baseInput && amountInput) {
            const base = parseFloat(baseInput.value) || 0;
            const amount = parseFloat(amountInput.value) || 0;
            
            totalBase += base;
            totalTax += amount;
        }
    }
    
    document.getElementById('totalBase').textContent = formatCurrency(totalBase);
    document.getElementById('totalTax').textContent = formatCurrency(totalTax);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('es-CO', { 
        style: 'currency', 
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

function resetForm() {
    document.getElementById('taxDeclarationForm').reset();
    document.getElementById('conceptsBody').innerHTML = '';
    document.getElementById('taxInfo').style.display = 'none';
    conceptCounter = 0;
    calculateTotals();
}

// Agregar conceptos comunes seg√∫n el tipo de impuesto
function addCommonConcepts() {
    const taxTypeSelect = document.getElementById('tax_type');
    const taxTypeName = taxTypeSelect.options[taxTypeSelect.selectedIndex].text.toLowerCase();
    
    if (taxTypeName.includes('iva')) {
        addPresetConcept('31', 'Ventas gravadas tarifa 19%', '19');
        addPresetConcept('32', 'Ventas gravadas tarifa 5%', '5');
        addPresetConcept('33', 'IVA descontable', '0');
    } else if (taxTypeName.includes('renta')) {
        addPresetConcept('26', 'Patrimonio l√≠quido', '0');
        addPresetConcept('27', 'Ingresos brutos', '0');
        addPresetConcept('28', 'Renta l√≠quida gravable', '33');
    }
}

function addPresetConcept(code, name, rate) {
    addConcept();
    const lastRow = document.querySelector('#conceptsBody tr:last-child');
    if (lastRow) {
        lastRow.querySelector('input[name*="concept_code_"]').value = code;
        lastRow.querySelector('input[name*="concept_name_"]').value = name;
        lastRow.querySelector('input[name*="tax_rate_"]').value = rate;
    }
}

// Validaci√≥n del formulario
document.getElementById('taxDeclarationForm').addEventListener('submit', function(e) {
    const concepts = document.querySelectorAll('#conceptsBody tr');
    if (concepts.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un concepto a la declaraci√≥n');
        return false;
    }
    
    let hasValidConcept = false;
    concepts.forEach(row => {
        const codeInput = row.querySelector('input[name*="concept_code_"]');
        const baseInput = row.querySelector('input[name*="tax_base_"]');
        const amountInput = row.querySelector('input[name*="tax_amount_"]');
        
        if (codeInput && codeInput.value && 
            ((baseInput && parseFloat(baseInput.value) > 0) || 
             (amountInput && parseFloat(amountInput.value) > 0))) {
            hasValidConcept = true;
        }
    });
    
    if (!hasValidConcept) {
        e.preventDefault();
        alert('Debe completar al menos un concepto con c√≥digo y base gravable o valor del impuesto');
        return false;
    }
});

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    // Agregar primer concepto autom√°ticamente
    addConcept();
    
    // Configurar fecha de vencimiento por defecto
    updateDueDate();
});
</script>
{% endblock %}
